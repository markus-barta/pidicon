# Version Management Strategy

## üéØ Overview

This project follows modern version management practices with a **single source of
truth** approach, leveraging semantic versioning and automated build metadata.

---

## üìã Version Components

### 1. **Semantic Version** (SemVer)

**Location**: `package.json` ‚Üí `"version": "2.0.0"`

**Format**: `MAJOR.MINOR.PATCH`

- **MAJOR**: Breaking changes, incompatible API changes
- **MINOR**: New features, backward-compatible
- **PATCH**: Bug fixes, backward-compatible

**When to Update**:

- Manual update in `package.json` before releasing
- Tag in Git: `git tag v2.0.0`
- Push tags: `git push --tags`

---

### 2. **Build Metadata** (Auto-generated)

**Location**: `version.json` (generated by `npm run build:version`)

**Contents**:

```json
{
  "version": "2.0.0",
  "deploymentId": "v2.0.0",
  "buildNumber": 380,
  "gitCommit": "bb4df03",
  "gitCommitFull": "bb4df03d0604f4cfc4a237fbb38df0611c3a4821",
  "gitCommitCount": 380,
  "gitBranch": "main",
  "gitTag": "v2.0.0",
  "buildTime": "2025-09-20T16:12:41.698Z",
  "environment": "development"
}
```

**Key Fields**:

- `version`: Copied from `package.json` (SemVer)
- `buildNumber`: Git commit count (monotonically increasing)
- `gitCommit`: Short commit hash (7 chars)
- `gitCommitFull`: Full commit hash (traceability)
- `buildTime`: ISO 8601 timestamp

---

## üîß Build Process

### **Local Development**

```bash
# Update version in package.json (manual, for releases)
npm version minor  # 1.0.4 ‚Üí 1.1.0
# or
npm version major  # 1.0.4 ‚Üí 2.0.0
# or
npm version patch  # 1.0.4 ‚Üí 1.0.5

# Generate version.json (before committing)
npm run build:version

# Commit and tag
git add package.json version.json
git commit -m "chore: bump version to 2.0.0"
git tag v2.0.0
git push origin main --tags
```

**Important**: Always run `npm run build:version` before committing to keep
version.json in sync with git commit count.

### **CI/CD Pipeline**

The Dockerfile automatically regenerates `version.json` during build:

```dockerfile
# Copy source (includes version.json baseline)
COPY . .

# Regenerate version.json with CI/CD build args
RUN npm run build:version

# Container now has fresh build metadata
```

The build pipeline:

1. Reads version from `package.json` (SemVer)
2. Gets build number from `git rev-list --count HEAD`
3. Embeds git commit hash and timestamp
4. Bakes `version.json` into Docker image
5. Deployed container displays this metadata on startup

### **Build Number Lifecycle**

```text
Commit 447 ‚Üí Push ‚Üí CI/CD builds ‚Üí Docker image (build #447) ‚Üí Deploy ‚Üí Pixoo shows "Build: 447"
     ‚Üì
Local work
     ‚Üì
Commit 448 ‚Üí version.json now shows 448 locally
     ‚Üì
     Push ‚Üí CI/CD builds ‚Üí Docker image (build #448) ‚Üí Deploy ‚Üí Pixoo shows "Build: 448"
```

**Key Point**: Local `version.json` will be ahead of deployed build after making
commits but before deployment completes. This is expected and correct.

---

## üìä Version Display

### **Startup Scene**

On daemon startup, the `startup` scene displays:

```text
v2.0.0
Build #380
bb4df03
```

This provides visual confirmation of the running version on the Pixoo device.

### **MQTT State Topic**

Published to `/home/pixoo/<ip>/scene/state`:

```json
{
  "version": "2.0.0",
  "buildNumber": 380,
  "gitCommit": "bb4df03"
}
```

### **Logs**

```text
[INFO] Pixoo Daemon v2.0.0 (build 380, commit bb4df03) starting...
```

---

## üö´ Anti-Patterns (What NOT to Do)

### ‚ùå **File Header Versions**

```javascript
/**
 * @version 1.0.0  ‚Üê NEVER DO THIS
 */
```

**Why not?**

- Impossible to keep in sync across hundreds of files
- Creates confusion when file says v1.0.0 but project is v2.0.0
- Adds maintenance burden with zero benefit
- Outdated practice from pre-Git era

### ‚ùå **Hardcoded Versions**

```javascript
const VERSION = '1.0.0'; // ‚ùå Don't hardcode
```

**Instead**:

```javascript
const { version } = require('./version.json'); // ‚úÖ Single source of truth
```

### ‚ùå **Multiple Version Files**

```text
version.txt
VERSION
.version
versions.json
```

**Why not?** Multiple sources of truth = guaranteed inconsistency

---

## ‚úÖ Best Practices

### 1. **Single Source of Truth**

- **Semantic Version**: `package.json` only
- **Build Metadata**: `version.json` only (auto-generated)
- All code references these files

### 2. **Automated Generation**

- `version.json` is ALWAYS auto-generated
- Never manually edit `version.json`
- Regenerate before every deployment

### 3. **Git Integration**

- Tag releases: `git tag v2.0.0`
- Build number = commit count (automatic, monotonic)
- Commit hash provides exact traceability

### 4. **Semantic Versioning**

Follow SemVer strictly:

- `2.0.0` ‚Üí `2.0.1`: Bug fix (patch)
- `2.0.0` ‚Üí `2.1.0`: New feature (minor)
- `2.0.0` ‚Üí `3.0.0`: Breaking change (major)

### 5. **Documentation References**

In documentation, reference the current version:

```text
**Current Version**: v2.0.0 (see `package.json`)
```

NOT:

```text
**Current Version**: v1.0.4  ‚Üê Will become stale immediately
```

---

## üìù Version History

Major releases and their significance:

- **v2.0.0** (2025-09-20): Complete architectural overhaul, centralized scheduler,
  professional error handling, 5 new modules, zero ESLint errors
- **v1.1.0** (2025-09-19): Centralized scheduler, pure-render scenes, input gating,
  observability improvements
- **v1.0.4** (2025-09-17): Initial stable release with basic scene management

For detailed changes, see Git tags and commit history.

---

## üîç Checking Current Version

### **From Command Line**

```bash
# Semantic version
node -p "require('./package.json').version"

# Full build metadata
cat version.json

# Git-based verification
git describe --tags --always
```

### **From Code**

```javascript
const packageInfo = require('./package.json');
const versionInfo = require('./version.json');

console.log(`Version: ${packageInfo.version}`);
console.log(`Build: ${versionInfo.buildNumber}`);
console.log(`Commit: ${versionInfo.gitCommit}`);
```

### **From MQTT**

```bash
mosquitto_sub -h $MQTT_HOST -t '/home/pixoo/+/scene/state' -C 1 | jq '.version'
```

### **From Device Display**

Send startup scene and visually verify version on the Pixoo screen:

```bash
mosquitto_pub -h $MQTT_HOST -t "pixoo/$DEVICE_IP/state/upd" -m '{"scene":"startup"}'
```

---

## üéØ Release Checklist

Before releasing a new version:

- [ ] Update version in `package.json`: `npm version major|minor|patch`
- [ ] Generate build metadata: `npm run build:version`
- [ ] Update CHANGELOG or release notes if applicable
- [ ] Commit changes: `git commit -am "chore: release v2.0.0"`
- [ ] Create Git tag: `git tag v2.0.0`
- [ ] Push with tags: `git push origin main --tags`
- [ ] CI/CD automatically builds and deploys
- [ ] Verify version on device startup scene
- [ ] Check MQTT state topic for correct version metadata

---

## üìö Related Documentation

- [package.json](./package.json) - Semantic version (source of truth)
- [version.json](./version.json) - Build metadata (auto-generated)
- [scripts/build-version.js](./scripts/build-version.js) - Version generator script
- [DEPLOYMENT.md](./DEPLOYMENT.md) - Deployment pipeline and CI/CD
- [STANDARDS.md](../STANDARDS.md) - Development standards and guidelines

---

**Summary**: One source of truth (package.json), automated metadata (version.json),
no version headers in code files, Git tags for releases, build numbers from commit
count. Simple, professional, maintainable.
