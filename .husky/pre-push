#!/usr/bin/env sh
set -eu

REMOTE="mba@miniserver24"
REMOTE_SCRIPT="/home/mba/scripts/watchtower-pidicon-run.sh"
REMOTE_COMPOSE="/home/mba/docker/docker-compose.yml"
SSH="ssh -o BatchMode=yes -o ConnectTimeout=5"

# Non-blocking: warn-only checks
$SSH "$REMOTE" 'echo OK_SSH >/dev/null' >/dev/null 2>&1 || exit 0
$SSH "$REMOTE" "test -x $REMOTE_SCRIPT" >/dev/null 2>&1 || exit 0
$SSH "$REMOTE" "test -f $REMOTE_COMPOSE" >/dev/null 2>&1 || exit 0

# Fire-and-forget on server; log to file
$SSH "$REMOTE" "nohup $REMOTE_SCRIPT --compose $REMOTE_COMPOSE --service watchtower-pidicon --target pidicon --interval 10 --timeout 500 --stop-timeout 5 >> /home/mba/scripts/watchtower-pidicon-run.log 2>&1 </dev/null &" >/dev/null 2>&1 || true

exit 0
